version: '3.8'

services:
  ghost:
    image: ghost:5-alpine
    restart: always
    ports:
      - "2368:2368"
    environment:
      # Ghost Configuration
      url: ${GHOST_URL:-http://localhost:2368}
      NODE_ENV: ${NODE_ENV:-development}
      
      # Database Configuration
      database__client: mysql
      database__connection__host: ghost-db
      database__connection__user: ${MYSQL_USER:-ghost}
      database__connection__password: ${MYSQL_PASSWORD:-ghostpass}
      database__connection__database: ${MYSQL_DATABASE:-ghost}
      
      # Mail Configuration (for newsletters)
      mail__transport: SMTP
      mail__options__service: ${MAIL_SERVICE:-Mailgun}
      mail__options__host: ${MAIL_HOST:-smtp.mailgun.org}
      mail__options__port: ${MAIL_PORT:-587}
      mail__options__secure: ${MAIL_SECURE:-false}
      mail__options__auth__user: ${MAIL_USER}
      mail__options__auth__pass: ${MAIL_PASSWORD}
      mail__from: ${MAIL_FROM:-noreply@behaviorschool.com}
      
      # Admin API Configuration
      admin__key: ${GHOST_ADMIN_KEY}
      
      # Content API Configuration  
      content__key: ${GHOST_CONTENT_KEY}
      
      # Privacy & Security
      privacy__useUpdateCheck: false
      privacy__useGravatar: false
      privacy__useRpcPing: false
      privacy__useStructuredData: true
      
      # Newsletter Configuration
      newsletter__showHeaderIcon: true
      newsletter__showHeaderTitle: true
      newsletter__showHeaderName: true
      newsletter__showBadge: false
      
      # Members & Subscriptions
      members__allowSelfSignup: true
      members__emailTemplate: true
      members__paidMembersEnabled: false
      
      # Portal Configuration
      portal__name: true
      portal__button: true
      portal__plans: '["free"]'
      portal__allowSelfSignup: true
      portal__signupTermsHtml: 'By subscribing, you agree to our terms and privacy policy.'
      portal__signupCheckboxRequired: false
      
    volumes:
      - ghost-content:/var/lib/ghost/content
    depends_on:
      - ghost-db
    networks:
      - ghost-network

  ghost-db:
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-rootpass}
      MYSQL_USER: ${MYSQL_USER:-ghost}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-ghostpass}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-ghost}
    volumes:
      - ghost-db-data:/var/lib/mysql
    networks:
      - ghost-network
    command: --default-authentication-plugin=mysql_native_password
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

volumes:
  ghost-content:
    driver: local
  ghost-db-data:
    driver: local

networks:
  ghost-network:
    driver: bridge